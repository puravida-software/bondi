name: main

on:
  push:
    branches:
      - main

# Limit concurrent runs for the `main` branch
concurrency:
  group: main

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - uses: extractions/setup-just@v3
        with:
          just-version: '1.46.0'
      - uses: ./.github/actions/ocaml-deps

      - name: Build
        run: just build

      - name: Test
        run: just test

      - uses: Homebrew/actions/setup-homebrew@master
      - name: Install Commitizen
        run: |
          brew install commitizen

      - name: Set release tag
        run: |
          set -euo pipefail
          NEXT_VERSION=$(just next-version)
          echo "RELEASE_VERSION=${NEXT_VERSION}" >> $GITHUB_ENV
          echo "RELEASE_TAG=v${NEXT_VERSION}" >> $GITHUB_ENV

      - name: Create GH release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          token: ${{ secrets.PAT_GITHUB }}
          tag_name: ${{ env.RELEASE_TAG }}
